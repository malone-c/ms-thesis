---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r echo=F, include=F}
library(ggplot2)
library(ggforce)
theme_set(theme_bw())
```


# Case study: Mediterranean fruit fly

TODO: Probabilistic graphical model of the entire model (with a box to demarcate the "internal" components from the components on which a prior distribution is set).
TODO: Plot the trapping grid.

## Introduction

TODO: Rewrite this intro in light of the model proposal chapter

In the previous chapter, I proposed to address a gap in the literature by providing an elaborate model for inferring the eradication of an incipient invasive population of Tephritid fruit flies. In this chapter, I present an illustrative model of medfly surveillance after an hypothetical invasion. I use a simplified model of Medfly population dynamics. However, for various species of Tephritid fruit fly (medfly included) detailed models exist. A benefit of the proposed method is that it can easily incorporate almost any model of medfly dynamics.^[Note, though, that the sampling method I use may not be appropriate in all cases. When the model predicts that the population size "explodes", then the rejection rate for the sampling algorithm may become very high, causing the algorithm to be highly inefficient.]

TODO:

* Note that this analysis is primarily illustrative. Performing a more specific analysis requires access to confidential data.
* Note that the method can be used for a real scenario - we only need to change the priors, data and locations of the traps.
* Note that I use a simplified model of Medfly dynamics for illustrative purposes - but the method can easily incorporate more complex ABS models, and cite those models.

TODO: Write one paragraph outlining this chapter

## Background

### Medfly are economically important

Mediterranean fruit fly (*Ceratitis Capitata*) or *medfly* are a particularly salient species of tephritid fruit fly. Medflies have high invasive potential, as it can adapt to a relatively large range of climates and environments, and is known to have the capability to infest the fruits of over 300 species of plants (Ibid.). Recently, an incursion of medfly in Adelaide, South Australia, prompted a large scale eradication effort. This comprised in part of hiring 350 special-purpose staff that set over 13,000 additional traps, and collected over 350 tonnes of fruit. The scale of the response to this outbreak indicates the perceived economic significance of this fruit fly species. 

### Medfly are cryptic

Medfly are very hard to detect at low levels. Monitoring for medfly is typically performed with the aid of lured traps (namely so-called Lynfield or Jackson traps). These traps are relatively ineffective for detecting medfly. For example, one study from the Adelaide metro area trapping grid found that only 0.02% of flies were recaptured from a release of 38.8 million flies. Further, medfly are known to have low dispersals across space. This means that low-lying populatons of flies may go undetected across generations. <https://onlinelibrary-wiley-com.virtual.anu.edu.au/doi/pdfdirect/10.1111/j.1570-7458.2006.00415.x>

## Data

### Zero sighting surveillance data

In this section, I do not use real data to estimate parameters. Instead, I model a hypothetical situation. The situation is as follows: We assume that at least one fly has been detected; eradication measures have since begun and then ceased; and we now proceed with intensified monitoring, while whatever population that may exist is free to grow relatively unhindered. The goal of the analysis is to infer the probability of eradication for the incipient population, given no flies detected at any point in this period. 

The data is a hypothetical survey record. The idea is to simulate a relatively realistic scenario. We observe the outcomes of a surveillance process. The surveillance process is generated by weekly checks of traps that are deployed uniformly in a given area (more about the trapping arrangement below). It is assumed that no specimens are detected at any point in the survey period. In other words, the sum of all detected counts in the period is zero.

### Data on capture probability: release recapture studies

Above, I described the "data" under the model. This is the set of variables that we condition on to infer the posterior distribution. However, we can use data from other sources to inform our prior distribution over the model's parameters. 

In cases where Bayesian models have been used, data has not been available on detection rates. For example, @caley2014 and @keith2013 set uninformative priors on the detection rates, and attempt to learn the detection rates for data. However, because of their global economic importance, tephritid fruit flies are relatively well studied. In particular, a number of fruit fly species have been studied with release recapture experiments. Release recapture experiments involve the release of a large number of (often sterilised) fruit flies. These studies help us to learn both the dispersal patterns and tendencies of various species of fly, but also the effectiveness of various trap types and layouts.

## Model

In this section, I discuss a model of medfly dynamics and detection. 

### Full model overview

I break the model into the following three components: (1) The size of the population (number of individuals); (2) the locations of individuals and traps; and (3) number of individuals caught in traps, conditional on (1) and (2).

The likelihood of a given number of captures is a function of latent variables, namely the number and locations of flies. Under the prior distribution, it is assumed that data at any given timestep are generated as follows. Firstly, nature draws a number of flies (i.e. a population size) which may or may not be based on the number of flies at the previous time step. Next, nature draws a location for each of the flies. Finally, nature draws a number of detections.

### Population size

In this case, $N_1$ is the first week after the most recent fly detection. I have chosen to give $N_1$ the prior distribution $N_1 \mid \lambda \sim \mathrm{Poisson}(\lambda)$, where $\lambda \sim \mathrm{Exponential}(0.05)$. This distribution for $N_1$ is chosen as it is a discrete distribution with right skew, and a relatively large amount of mass $f_{N_1}(x)$ at $x = 0$, corresponding to the situation where flies are already eradicated (see @prior_init_size)

```{r prior_init_size, fig.cap = 'Prior distribution of initial population size'}
g = 1/20
init_pmf = function(n, g) g / (1+g)^(n+1)

x = 0:100

df = data.frame(x = x, y = init_pmf(x, g))

ggplot(df) +
  geom_bar(stat = 'identity', aes(x, y)) +
  xlab(bquote(italic(n))) +
  ylab(bquote('Pr('*italic(N)[1] == italic(n)*')'))

# Prior probability that they're already eradicated
```

As for the population sizes at later time points, I assume that growth is exponential at an uncertain rate. In particular, it is assumed that, for $t \in \{2, \ldots, T\}$,  $N_t \mid N_{t-1}, R_t \sim \mathrm{Poisson}(N_{t-1} e^{R_t})$. Here, we can give any continuous distribution for $R_t$. I have chosen the vaguely informative prior $R_t \stackrel{\text{iid}} \sim \mathrm N(0, 0.2)$. The symmetry of this prior means that we are indifferent about whether the population is growing or declining. 

The growth rate prior has been chosen to place the vast majority of density below their estimated growth rate under optimal conditions. Medfly have been estimated to grow at 8% per day, in optimal lab conditions (@papadopoulos2002). Under an exponential growth model this is 56% per week. This can be taken as an extremely *pessimistic* upper bound on the growth rate. In real cases, flies may fail to establish due to food scarcity, predation, and/or unsustainably low population density.

In real cases, it will be desirable to attempt to estimate $R_t$ from data. In particular, it is known that fruit fly population growth rates are highly dependent on temperature. Therefore, it would be wise to estimate and draw values of $R_t$ conditional on weather measurements. Choosing an empirically realistic distribution for $R_t$ is likely to improve the efficiency of inference from the survey record. 

### Spatial location

As mentioned in the previous chapter, the model is spatial, insofar as likelihood of detection depends on distances between traps and individual flies.

TODO: Explain that the centre of the grid is the site of the last detection.

#### Population location

The centre of of the population is assumed to be located at the two dimensional vector $L$. I have set the prior on $L$ to be 
$$
L \sim \mathrm {Normal}_2 (\mathbf 0_2, 160^2 I_2),
$$
where $\mathrm{Normal}_2$ is the bivariate normal distribution, $\mathbb 0_2$ is the two-dimensional zero vector and $I_2$ is the $2 \times 2$ identity matrix. This prior reflects a prior belief that the centre of the population is highly likely to be found somewhere on a disc with. E.g., we believe that there is a 95% chance that the centre of the population is within $1.96 \cdot 160 \approx 320$ metres of the centre of the grid.^[For details about how this prior was arrived at, see appendix.] Recall that this makes sense because we believe that the flies are within the distribution.

#### Individual fly dispersals

I assume that, for any given fly, their prior distance from the central location is described by
$$
D_{i,t} \sim \mathrm {Normal}_2 (\mathbf 0_2, 12.5^2 I_2)
$$
where the notation is defined as in the previous section above. The variance of this distribution 

The normal distribution is chosen for a few reasons. Firstly, it is conceptually simple and intuitive to parameterise. Secondly, the location of fly $i$ at time $t$, namely $L + D_{i, t}$, has a simple marginal distribution, thanks to the fact that the sum of normal random variables is itself normal. Thirdly, for mean zero normal random variables, distances to the origin have a known distribution. For example, let $$\mathbf X = (X_1, \ldots, X_p)^\top \sim \mathbf N_p(0, \sigma^2 I),$$ where $I$ is the $p \times p$ identity matrix. Then the length of $\mathbf X$, $\lVert \mathbf X \rVert^{1/2} \sim \mathrm{Gamma}(??????)$ @unfinished (see appendix). This allows us to compare and calibrate the distribution against experimental results (see appendix). This, in turn, makes elicitation of priors simpler and more intuitive.

It may be worth noting that, in real cases, the assumed prior distribution on dispersals may not be reasonable. For example, dispersals may have non-zero mean (due to strength and direction) or non-spherical covariance matrix (i.e. non-equal variances and/or non-zero covariances).^[This is argued by @baker1986.] In applied cases, it may be possible to use information about wind directions to set more informative priors. This is beyond the scope of this work.

### Trap locations

```{r trap_grid, fig.cap = 'Illustration of the hypothetical trapping grid. Grey circle represents 200m radius disc surrounding the site of the most most recently detected medfly specimen.'}

grid_size = 4
general_grid_1d = seq(-grid_size / 2, grid_size / 2) * 400
general_grid = expand.grid(general_grid_1d, general_grid_1d)
general_traps = as.matrix(general_grid)

d = 200 / sqrt(2)
supp_grid_1d = seq(-d, d, length.out = 4)
supp_traps = expand.grid(supp_grid_1d, supp_grid_1d)
all_traps = rbind(general_traps, supp_traps)

supp_indicator = rep(c('General', 'Supplementary'), c(nrow(general_traps), nrow(supp_traps)))
traps_df = data.frame(all_traps, factor(supp_indicator, c('Yes', 'No')))

# Plot of traps
ggplot(traps_df) +
  geom_circle(aes(x0=0, y0=0, r=200), colour = 'grey') +
  geom_point(aes(Var1, Var2, col=supp_indicator)) +
  coord_fixed() +
  xlab('X coordinate (metres)') +
  ylab('Y coordinate (metres)') +
  labs(col = 'Trap type') +
  scale_x_continuous(breaks = (-4:4)*200) +
  scale_y_continuous(breaks = (-4:4)*200) 
  
```


By intensified monitoring, I mean that **supplementary** monitoring traps have been placed alongside the previously existing grid of **general** monitoring traps. More precisely, it is assumed that **general** surveillance traps are placed year round in a 400 $\times$ 400 metre grid (DPIPWE, 2011, p. 50). The **supplementary** surveillance system consists of a set of 16 traps in a circular area, centred at the site of the first fly detection.^[It is typical to wait until at least 2 flies have been detected near each other for an outbreak to be declared. To illustrate the method in a simplified setting, I suppose that one fly detection is sufficient.]

#### Probability of capture

I assume that the probability of capture for a given fly in a given trap is 
$$
p(x) = \begin{cases}ax^{-b}, & d>1 \\ a & 0 \geq d \geq 1\end{cases}
$$
where $a = 0.4702111$, $b = 1.37$, and $x$ is the distance between the fly and the trap at the start of the period. Thresholding is introduced because (a) the function does not yield valid probabilities for small enough $x$. In general, the use of a negative exponential function is not ideal here. This function is used for convenience as it is provided by the authors of the study, and data is not publicly accessible. For a more detailed analysis, it may be 

The results of release recapture studies are highly variable, and gaining access to data may be difficult for older studies. In this case, it may be desirable to incorporate uncertainty about the probability function. This could be done, for example, by assigning prior distributions to the coefficients $a$ and $b$. I do not explore this any further here, as this model exposition is intended for the purposes of illustration only.

## Computing the posterior distribution

In this section, I discuss the problem of computing the posterior distribution, given a survey record. Above, I stated that the model could be defined flexibly. Without restrictions on the form of the growth and detection models, the posterior may be analytically intractable. In other words, we will not be able to write out the posterior density or mass as a function of the data and prior distributions. Such situations are common in the Bayesian framework, because of the tendency for the posterior density or mass to depend, implicitly or explicitly, on analytically intractable integrals.

So far, we have talked about situations when sampling is required for inference. Further problems arise when the model is *agent-based*. In other words, when we include uncertainty about individual-level features in the model. In this case, the detection probability is random, even when the location and population size is known. In other words, the probability of detecting at least one individual is a function of the number of individuals, and also their individual (random) properties. This is a situation in which "the number of things you do not know is one of the things you do not know" (Richardson and Green, 1997).

### ABC models

A simple rejection algorithm is used to draw samples from the posterior distribution. 


Here, I have used EBC for intuitiveness, ease of implementation, and the fact that it is relatively efficient for this problem. However, other methods exist that may be worth exploring, for analogous problems where the rejection rate of ABC is higher. There are at least two known methods for sampling from the posterior when the dimension of the parameter space is uncertain. These are the reversible jump MCMC sample (@green1995) and the generalised Gibbs sampler (@keith2015). These may be worth exploring for problems where the rejection rate is high for EBC.

Interestingly, the standard justifications for and against ABC do not apply to the case under consideration. Firstly, the standard justification for ABC is that it allows for inference when the likelihood function is "intractable" - i.e., unknown, uncomputable or otherwise difficult to work with. However, for the current model, the likelihood is known, and relatively simple to write out.

On the other hand, the standard drawback for ABC is that it ensures that we can typically only draw from the posterior approximately. Under standard conditions, we must define a criteria for similarity between simulated and observed data. This is typically done by specifying a summary statistic $S(\mathbb y)$, and a similarity measure $\rho(S(\mathbb y), S(\mathbb y'))$ defined over the space spanning our data $\mathbb y$. We reject a sample if we observe $\rho(\mathbb y_{\text{observed}}, \mathbb y_{\text{simulated}} ) >  \epsilon_0$, where $\epsilon_0$.

$10{,}000$ samples were taken. The acceptance rate for sampling was 0.68. This high level of acceptance is due to the low likelihood of captures, across most of the high prior density region of the model space.

* How long did sampling take?
* What was the rejection rate?

## Results

* The fly free period is 12 weeks or 28 days and one generation, whichever is longer (@meats2005). In summer, a Medfly generation takes 28-34 days (@dpirdwa). Therefore, the period I look at is over 12 weeks. However, this may be different based on the period that the manager is interested in.

The posterior probability of extinction after 12 weeks is approximately 0.684.^[Unfortunately, it is not straightforward to visualise the prior or posterior density of this quantity.]

## Discussion

Here I discuss limitations and objections.

### Drawbacks

* We do not get a posterior distribution over the probability of eradication. 

TODO: Section on objections to/limitations of the model

* Objection: the model is subjective
* Objection: The model is too sensitive to priors. 
  - Defence in Caley 2015

TODO: Write conclusion of this chapter

