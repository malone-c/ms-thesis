---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r echo=F, include=F}
library(ggplot2)
theme_set(theme_bw())
```


# Case study: Ceratatis capitata

## Introduction

* What this chapter is about
In the previous chapter, I proposed to address a gap in the literature by providing an elaborate model for inferring the eradication of an incipient invasive population of Tephritid fruit flies. In this chapter, I present an illustrative model of medfly surveillance after an hypothetical invasion. I use a simplified model of Medfly population dynamics. However, for various species of Tephritid fruit fly (medfly included) detailed models exist. A benefit of the proposed method is that it can easily incorporate almost any model of medfly dynamics.^[Note, though, that the sampling method I use may not be appropriate in all cases. When the model predicts that the population size "explodes", then the rejection rate for the sampling algorithm may become very high, causing the algorithm to be highly inefficient.]


* Note that this analysis is primarily illustrative. Performing a more specific analysis requires access to confidential data.
* Note that the method can be used for a real scenario - we only need to change the priors, data and locations of the traps.
* Note that I use a simplified model of Medfly dynamics for illustrative purposes - but the method can easily incorporate more complex ABS models, and cite those models.

* Outline of this chapter

## Background

### Medfly are economically important

Mediterranean fruit fly (*Ceratitis Capitata*) or *medfly* is a fly species native to sub-Saharan Africa. It is considered to be of high economic importance, due to its potential for destruction of fruit production (@sciarretta2018). Medfly has high invasive potential, as it can adapt to a relatively large range of climates and environments, and is known to have the capability to infest the fruits of over 300 species of plants (Ibid.). 

### Medfly are cryptic

Medfly are very hard to detect at low levels. Monitoring for medfly is typically performed with the aid of lured traps (namely so-called Lynfield or Jackson traps). These traps are relatively ineffective for detecting medfly. For example, one study from the Adelaide metro area trapping grid found that only 0.02% of flies were recaptured from a release of 38.8 million flies. Further, medfly are known to have low dispersals across space. This means that low-lying populatons of flies may go undetected across generations. <https://onlinelibrary-wiley-com.virtual.anu.edu.au/doi/pdfdirect/10.1111/j.1570-7458.2006.00415.x>

## Data

### Zero sighting surveillance data

In this section, I do not use real data to estimate parameters. Instead, I model a hypothetical situation. The situation is as follows: We assume that at least one fly has been detected; eradication measures have since begun and then ceased; and we now proceed with intensified monitoring, while whatever population that may exist is free to grow relatively unhindered. The goal of the analysis is to infer the probability of eradication for the incipient population, given no flies detected at any point in this period. 

The data is a hypothetical survey record. We assume a fairly realistic scenario. We observe the outcomes of a surveillance process. The surveillance process is generated by weekly checks of traps that are deployed uniformly in a given area (more about the trapping arrangement below). It is assumed that no specimens are detected at any point in the survey period. In other words, the sum of all detected counts in the period is zero.

### Data on capture probability

Above, I described the "data" under the model. This is the set of variables that we condition on to infer the posterior distribution. However, we can use data from other sources to inform our prior distribution over the model's parameters. 

In cases where Bayesian models have been used, data has not been available on detection rates. For example, @caley2014 and @keith2013 set uninformative priors on the detection rates, and attempt to learn the detection rates for data. In the case of medfly, however, there is a body of experimental literature which can be used to understand capture rates for the species.

## Model

In this section, I discuss a model of medfly dynamics and detection. 

### Full model overview

I break the model into the following three components: (1) The size of the population (number of individuals); (2) the locations of individuals and traps; and (3) number of individuals caught in traps, conditional on (1) and (2).

The likelihood of a given number of captures is a function of latent variables, namely the number and locations of flies. Under the prior distribution, it is assumed that data at any given timestep are generated as follows. Firstly, nature draws a number of flies (i.e. a population size) which may or may not be based on the number of flies at the previous time step. Next, nature draws a location for each of the flies. Finally, nature draws a number of detections.

### The population size

The growth model describes our prior beliefs about how a population of size $N_1$ might grow or decline over time.

* Overview
* Technical details
* Specific priors



#### Overview

A natural way to set a prior on the population size at each time point $t$ is to set a prior on the population size at the initial time point, and then assume that the population sizes at other time points are given by some (deterministic or stochastic) function of the population size at $t-1$, and the value of a covariate vector $X_t$, which includes variables relevant to population growth.

It may be worth noting that there are no a priori assumptions on the population dynamics for the growth model. Thanks to the generality of the sampling algorithm, it is simple to "plug in" elaborate growth models. For example, the models of @lux2018 or @manoukis2014 could be used to generate independent random draws from the population of Medfly. In this way, they can structure our prior over the population size. In this case, inference would proceed simple as in the case I outline here. This highlights a benefit of the modelling approach taken here, which is its generality and modularity.


$$
N_t = f(N_{t-1}, X_t)
$$

#### Technical details

As for prior distributions on $N_t$, for $t \in \{1, \ldots, T\}$, a growth model is used to structure the prior. Namely, an exponential growth model is assumed, so that $N_t = \mathrm{round}[N_{t-1} \exp\{R_t\}]$, where $R_t$ is the growth rate at time $t$. The exponential growth model is chosen for its ubiquity in ecological science in general, and in studies of fruit fly dynamics in particular. Rounding is introduced to give $N_t$ discrete support. The growth parameter $R_t$ is uncertain, and based on temperature.^[Alternatively, we could leave the rounding step out, and interpret $N_t$ as the expected number of flies at each step. I do not consider this possibility in any further depth.]

#### Population size priors

In this case, $N_1$ is the first week after the most recent fly detection. I have chosen to give $N_1$ the prior distribution $N_1 \mid \lambda \sim \mathrm{Poisson}(\lambda)$, where $\lambda \sim \mathrm{Exponential}(\gamma)$. I have set $\gamma$ to $0.05$. This distribution for $N_1$ is chosen as it is a discrete distribution with right skew, and a relatively large amount of mass $f_{N_1}(x)$ at $x = 0$, corresponding to the situation where flies are already eradicated. 

```{r prior_init_size, fig.cap = 'Prior distribution of initial population size'}

g = 1/20
init_pmf = function(n, g) g / (1+g)^(n+1)

x = 0:100

df = data.frame(x = x, y = init_pmf(x, g))

ggplot(df) +
  geom_bar(stat = 'identity', aes(x, y)) +
  xlab(bquote(italic(n))) +
  ylab(bquote('Pr('*italic(N)[1] == italic(n)*')'))

# Prior probability that they're already eradicated
curve(exp(g^2 * x^(g-1)))

prior_prob = function(x) g^2 * x^(g-1)

x = seq(0, 1, 0.001)

df_dens = data.frame(x = x, y = prior_prob(x))
ggplot(df_dens) +
  geom_function(fun = \(x) g * x^(g-1), 
                n = 1e4) +
  xlim(c(0, 0.01)) +
  ggtitle('Density of initial (prior) probability of eradication') +
  xlab('x') +
  ylab('Density')
```

As for the population sizes at later time points, I assume that growth is exponential at an uncertain rate. In particular, it is assumed that, for $t \in \{2, \ldots, T\}$,  $N_t \mid N_{t-1}, R_t \sim \mathrm{Poisson}(N_{t-1} e^{R_t})$. Here, we can give any continuous distribution for $R_t$. I have chosen the vaguely informative prior $R_t \stackrel{\text{iid}} \sim \mathrm N(0, 20)$. The symmetry of this prior means that we are indifferent about whether the population is growing or declining. 

The growth rate prior has been chosen to place most density below their estimated growth rate under optimal conditions. Medfly have been estimated to grow at 8% per day, in optimal lab conditions (@papadopoulos2002). Under an exponential growth model this is 56% per week. This can be taken as an extremely pessimistic upper bound on the growth rate. In real cases, flies may fail to establish due to food scarcity and unsustainability of population size. This is due to predation and other environmental pressures.

In real cases, it will be desirable to attempt to estimate $R_t$ from data. In particular, it is known that fruit fly population growth rates are highly dependent on temperature. Therefore, it would be wise to estimate and draw values of $R_t$ conditional on weather measurements. Choosing an empirically realistic distribution for $R_t$ is likely to improve the efficiency of inference from the survey record. 

### Locations

#### Population location

* Overview
* Technical details
* Priors

For the distribution of the centre of the population, I have chosen a normal prior, centred at the origin (where the first fly was found). For details about this, see the appendix.

I first discuss the option of setting a uniform prior. Setting an uninformative prior is fairly straightforward for this problem. In particular, we might assume that, beyond a certain distance from the outbreak centre (say, 1km) any existing population of Medfly is distinct from the population of interest. Therefore, we might set the prior distribution for the population location to be uniform on the surface of a disk with 1km radius around the outbreak centre. 

Despite the fact that an uninformative prior is relatively straightforward to set, it is most likely not advisable in specific applications. It will typically be the case that prior information is available to the decision maker. In particular, fruit flies are heavily dependent on the availability of suitable fruit trees for survival and reproduction. Therefore, someone with local area knowledge will be able to determine the most likely locations for an existing population. Also, the supplementary zone is not chosen arbitrarily. The choice of supplementary zone will typically reflect the beliefs of the decision maker about the location of the fly population. 

When prior information exists, setting the prior distribution to be uninformative may cause us to underestimate the likelihood of observing captures in the supplementary surveillance zone. The overall effect will be to inflate $\Pr(N_T = 0 \mid \mathbf y = \mathbf 0_T)$.

#### Individual fly dispersals

* Overview
* Technical details
* Priors

In release-recapture experiments, it is often the case that flies are released from a single point in the trapping grid (@lg2004, @wong1982). In the simplest model of detection, we might assume that this happens in the real world. In that case, the distance between each trap and each fly would just be the distance between that trap and the population. In other words, flies would all be clustered at a single point. However, this may not be reasonable in practice. Instead, it may be more reasonable to assume that flies are dispersed around a central point.

To incorporate dispersion of flies, I assume the following. Let $L$ denote the central point of the population, as above. Then, let $D_{i, t}$ denote the location of fly $i$ at time $t$, relative to the population centroid $L$. For simplicity, it is assumed that $D_{i, t}$ is independent of $D_{i', t'}$, for any $(i', t') \neq (i, t)$. Thus, our belief is essentially that flies are shuffled around at each time point, so that a fly's location at $t-1$ tells us nothing about its location at $t$ (except through the information both reveal about $L$). This simply means that we do not track the locations of flies across time -- i.e., whether a fly lives across time periods, or instead dies and is replaced, are equivalent scenarios under this model.

The normal distribution is chosen for two reasons. Firstly, it is conceptually simple and intuitive to parameterise. Secondly, for mean zero normal random variables, distances to the origin have a known distribution. For example, let $$\mathbf X = (X_1, \ldots, X_p)^\top \sim \mathbf N_p(0, \sigma^2 I),$$ where $I$ is the $p \times p$ identity matrix. Then the length of $\mathbf X$,  $\lVert \mathbf X \rVert^{1/2} \sim \mathrm{Gamma}(??????)$ @unfinished (see appendix). This allows us to compare and calibrate the distribution against experimental results (see appendix). This, in turn, makes elicitation of priors simpler and more intuitive.

### The detection model

* Overview
* Technical details
* Priors

#### Overview

The second key assumption is that we can estimate the probability of capturing a randomly selected fly from data. This is difficult in the case of Medfly. For fruit flies, capture probability is typically estimated from data taken from release-recapture studies. In these studies, the researcher obtains a large collection of sterilised specimens, and releases them at a single point in space. Then, the 

These experimental data can be useful when the trapping setup is similar to the setup we want to draw inference about. However, this will often not be the case. For example, studies vary in the number and type of traps used (SEE NOTE). Further, we may wish to infer eradication of pest populations in trapping systems that are unlike those in studies. For example, after an outbreak has occurred, and eradication measures have been stopped, it is common to set up supplementary trapping units to intensify monitoring and increase the likelihood of detecting flies, conditional on their presence in the area. (@supp_traps). 

The 16 extra traps are included because they increase the probability of detecting flies. Because they increase the likelihood of detections, they have a stronger effect on the posterior distribution. 


#### Technical details

I assume that surveillance events occur at regular time intervals $t \in \{1, \cdots, T\}$. The probability that a fly $i$ is caught in trap $k$ at time $t$ is given by $p_{i, k, t} = p(d_{i, k, t})$ where $d$ is the distance between fly $i$ and trap $k$ at time $t$, and $p(\cdot)$ gives us the probability of capture as a function of distance.

* No interference.

#### Priors

I assume that the probability of capture is given by
$$
p(d) = \max(0.0073d^{-1.37}, 1),
$$
for $d > 0$.

The results of release recapture studies are highly variable, and gaining access to data may be difficult for older studies. In this case, it may be desirable to incorporate uncertainty about the probability function. This could be done by definining a random. I do not explore this any further here, as this model exposition is intended for the purposes of illustration only.
    
#### The trapping arrangement

* Show plot of the trapping grid.
* Note that the number of traps is assumed fixed as it would be in a real scenario.
* Note that the trap locations would be known in a real analysis.

By intensified monitoring, I mean that **supplementary** monitoring traps have been placed alongside the previously existing grid of **general** monitoring traps. More precisely, it is assumed that **general** exist year round in a 400 $\times$ 400 metre grid (DPIPWE, 2011, p. 50). The **supplementary** surveillance system consists of a set of 16 traps in a circular area, centred at the site of the first fly detection.^[It is typical to wait until at least 2 flies have been detected near each other for an outbreak to be declared. To illustrate the method in a simplified setting, I suppose that one fly detection is sufficient.]

## Computing the posterior distribution

In this section, I discuss the problem of computing the posterior distribution, given a survey record. Above, I stated that the model could be defined flexibly. Without restrictions on the form of the growth and detection models, the posterior may be analytically intractable. In other words, we will not be able to write out the posterior density or mass as a function of the data and prior distributions. Such situations are common in the Bayesian framework, because of the tendency for the posterior density or mass to depend, implicitly or explicitly, on analytically intractable integrals.

So far, we have talked about situations when sampling is required for inference. Further problems arise when the model is *agent-based*. In other words, when we include uncertainty about individual-level features in the model. In this case, the detection probability is random, even when the location and population size is known. In other words, the probability of detecting at least one individual is a function of the number of individuals, and also their individual (random) properties. This is a situation in which "the number of things you do not know is one of the things you do not know" (Richardson and Green, 1997).

A simple rejection algorithm is used to draw samples from the posterior distribution. 

### ABC models

ABC methods, as exemplified by Caley's model, are a promising approach. Here, I will give a brief description of the family of sampling algorithms known collectively as Approximate Bayesian Computation (ABC). In its simplest form, ABC is a form of rejection sampling. 

### Motivation for ABC

There are two reasons for sampling with ABC. Firstly, the likelihood may be unattractive to work with due to its complexity. Secondly, when our model incorporates uncertainty about the individual members of a population, whose size is itself uncertain, standard sampling techniques do not work. 

Two things should be noted before moving on. Firstly, the reader may note that the justification given for ABC is unusual. ABC is relatively recent technique for sampling in cases where traditional sampling techniques fail. Standard techniques for MCMC, such as Metropolis-Hastings and Gibbs sampling, assume that the likelihood function is known and can be easily computed. This may not be the case if, for example, computing the likelihood requires us to integrate out a latent variable, but the likelihood is not integrable with respect to that variable.

Secondly, the reader may note that there exist other methods for sampling from the posterior.

Here, I have used EBC for intuitiveness, ease of implementation, and the fact that it is relatively efficient for this problem. However, other methods exist that may be worth exploring, for analogous problems where the rejection rate of ABC is higher. There are at least two known methods for sampling from the posterior when the dimension of the parameter space is uncertain. These are the reversible jump MCMC sample (@green1995) and the generalised Gibbs sampler (@keith2015). These may be worth exploring for problems where the rejection rate is high for EBC.

Interestingly, the standard justifications for and against ABC do not apply to the case under consideration. Firstly, the standard justification for ABC is that it allows for inference when the likelihood function is "intractable" - i.e., unknown, uncomputable or otherwise difficult to work with. However, for the current model, the likelihood is known, and relatively simple to write out.

On the other hand, the standard drawback for ABC is that it ensures that we can typically only draw from the posterior approximately. Under standard conditions, we must define a criteria for similarity between simulated and observed data. This is typically done by specifying a summary statistic $S(\mathbb y)$, and a similarity measure $\rho(S(\mathbb y), S(\mathbb y'))$ defined over the space spanning our data $\mathbb y$. We reject a sample if we observe $\rho(\mathbb y_{\text{observed}}, \mathbb y_{\text{simulated}} ) >  \epsilon_0$, where $\epsilon_0$.

## Results

* How long did sampling take?
* What was the rejection rate?

* The fly free period is 12 weeks or 28 days and one generation, whichever is longer (@meats2005). In summer, a Medfly generation takes 28-34 days (@dpirdwa). Therefore, the period I look at is over 12 weeks. However, this may be different based on the period that the manager is interested in.

### Probability of extinction after 12 weeks

## Discussion

Here I discuss limitations and objections.

### Drawbacks

* We do not get a posterior distribution over the probability of eradication. 

### Objections

#### Bayesian models are too subjective

#### Bayesian models are too sensitive to priors
  - Defence in Caley 2015


